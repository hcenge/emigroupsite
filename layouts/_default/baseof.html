<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>{{ block "title" . }}{{ .Title }} | {{ .Site.Title }}{{ end }}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    {{ $researchCSS := resources.Get "css/research.css" | fingerprint }}
    <link rel="stylesheet" href="{{ $researchCSS.RelPermalink }}" integrity="{{ $researchCSS.Data.Integrity }}">
    {{ block "head" . }}{{ end }}
  </head>
  <body class="bbc-shell">
    <header class="bbc-topbar">
      <button class="bbc-hamburger" id="menu-toggle" aria-label="Toggle menu">
        <span></span>
        <span></span>
        <span></span>
      </button>
      <div class="bbc-brand">
        <a href="/" class="bbc-logo">
          <span class="bbc-logo__block">E</span>
          <span class="bbc-logo__word">nergy</span>
          <span class="bbc-logo__block">M</span>
          <span class="bbc-logo__word">aterials</span>
          <span class="bbc-logo__block">I</span>
          <span class="bbc-logo__word">nterfaces</span>
        </a>
      </div>
    </header>
    {{ with site.Menus.main }}
    <nav class="bbc-nav" id="main-nav">
      {{ range . }}
      <a href="{{ .URL }}">{{ .Name }}</a>
      {{ end }}
    </nav>
    {{ end }}
    <main class="bbc-main">
      {{ block "main" . }}{{ end }}
    </main>
    <footer class="bbc-footer">
      <p>&copy; {{ now.Format "2006" }} {{ .Site.Title }}. All rights reserved.</p>
    </footer>
    <script>
      // Parallax scroll effect for hero banner
      document.addEventListener('DOMContentLoaded', function() {
        const banner = document.getElementById('hero-banner');
        if (banner) {
          const bg = banner.querySelector('.bbc-hero-banner-parallax__bg');

          function updateParallax() {
            const scrolled = window.pageYOffset;
            const bannerHeight = banner.offsetHeight;

            if (scrolled < bannerHeight) {
              const yPos = scrolled * 0.5;
              bg.style.transform = `translate3d(0, ${yPos}px, 0)`;
            }
          }

          window.addEventListener('scroll', updateParallax, { passive: true });
        }

        // Hamburger menu toggle
        const menuToggle = document.getElementById('menu-toggle');
        const mainNav = document.getElementById('main-nav');

        if (menuToggle && mainNav) {
          menuToggle.addEventListener('click', function() {
            menuToggle.classList.toggle('active');
            mainNav.classList.toggle('active');
          });

          // Close menu when clicking a link
          const navLinks = mainNav.querySelectorAll('a');
          navLinks.forEach(link => {
            link.addEventListener('click', function() {
              menuToggle.classList.remove('active');
              mainNav.classList.remove('active');
            });
          });
        }

        // Group photos carousel
        const groupPhotosCarousel = document.querySelector('.bbc-group-photos-carousel');
        if (groupPhotosCarousel) {
          const container = groupPhotosCarousel.querySelector('.bbc-group-photos-carousel__container');
          const track = groupPhotosCarousel.querySelector('.bbc-group-photos-carousel__track');
          const items = groupPhotosCarousel.querySelectorAll('.bbc-group-photos-carousel__item');
          const prevBtn = groupPhotosCarousel.querySelector('.bbc-group-photos-carousel__button--prev');
          const nextBtn = groupPhotosCarousel.querySelector('.bbc-group-photos-carousel__button--next');
          const dotsContainer = groupPhotosCarousel.querySelector('.bbc-group-photos-carousel__dots');
          const dateDisplay = groupPhotosCarousel.querySelector('.bbc-group-photos-carousel__date');

          if (items.length > 0) {
            let currentIndex = 0;
            const totalSlides = items.length;

            // Get dates from images alt text
            const dates = Array.from(items).map(item => {
              const img = item.querySelector('img');
              const altText = img.getAttribute('alt');
              return altText.replace('Group photo from ', '');
            });

            // Create dots
            for (let i = 0; i < totalSlides; i++) {
              const dot = document.createElement('button');
              dot.classList.add('bbc-group-photos-carousel__dot');
              dot.setAttribute('aria-label', `Go to photo ${i + 1}`);
              if (i === 0) dot.classList.add('bbc-group-photos-carousel__dot--active');
              dot.addEventListener('click', () => goToSlide(i));
              dotsContainer.appendChild(dot);
            }

            const dots = dotsContainer.querySelectorAll('.bbc-group-photos-carousel__dot');

            function updateCarousel() {
              const itemWidth = items[0].offsetWidth;
              const gap = 32; // 2rem = 32px
              const offset = currentIndex * (itemWidth + gap);
              track.style.transform = `translateX(-${offset}px)`;

              // Update date
              dateDisplay.textContent = dates[currentIndex];

              // Update dots
              dots.forEach((dot, index) => {
                dot.classList.toggle('bbc-group-photos-carousel__dot--active', index === currentIndex);
              });

              // Update button states
              prevBtn.disabled = currentIndex === 0;
              nextBtn.disabled = currentIndex >= totalSlides - 1;
            }

            function goToSlide(index) {
              currentIndex = Math.max(0, Math.min(index, totalSlides - 1));
              updateCarousel();
            }

            prevBtn.addEventListener('click', () => {
              if (currentIndex > 0) {
                currentIndex--;
                updateCarousel();
              }
            });

            nextBtn.addEventListener('click', () => {
              if (currentIndex < totalSlides - 1) {
                currentIndex++;
                updateCarousel();
              }
            });

            // Update on window resize
            let resizeTimeout;
            window.addEventListener('resize', () => {
              clearTimeout(resizeTimeout);
              resizeTimeout = setTimeout(() => {
                updateCarousel();
              }, 250);
            });

            // Initialize
            updateCarousel();
          }
        }

        // News carousel
        const carousel = document.querySelector('.bbc-news-carousel');
        if (carousel) {
          const track = carousel.querySelector('.bbc-news-carousel__track');
          const items = carousel.querySelectorAll('.bbc-news-carousel__item');
          const prevBtn = carousel.querySelector('.bbc-news-carousel__button--prev');
          const nextBtn = carousel.querySelector('.bbc-news-carousel__button--next');
          const dotsContainer = carousel.querySelector('.bbc-news-carousel__dots');

          if (items.length > 0) {
            let currentIndex = 0;
            const itemsToShow = window.innerWidth <= 900 ? 1 : 3;
            const totalSlides = Math.ceil(items.length / itemsToShow);

            // Create dots
            for (let i = 0; i < totalSlides; i++) {
              const dot = document.createElement('button');
              dot.classList.add('bbc-news-carousel__dot');
              dot.setAttribute('aria-label', `Go to slide ${i + 1}`);
              if (i === 0) dot.classList.add('bbc-news-carousel__dot--active');
              dot.addEventListener('click', () => goToSlide(i));
              dotsContainer.appendChild(dot);
            }

            const dots = dotsContainer.querySelectorAll('.bbc-news-carousel__dot');

            function updateCarousel() {
              const itemWidth = items[0].offsetWidth;
              const gap = 24; // 1.5rem = 24px
              const offset = currentIndex * itemsToShow * (itemWidth + gap);
              track.style.transform = `translateX(-${offset}px)`;

              // Update dots
              dots.forEach((dot, index) => {
                dot.classList.toggle('bbc-news-carousel__dot--active', index === currentIndex);
              });

              // Update button states
              prevBtn.disabled = currentIndex === 0;
              nextBtn.disabled = currentIndex >= totalSlides - 1;
            }

            function goToSlide(index) {
              currentIndex = Math.max(0, Math.min(index, totalSlides - 1));
              updateCarousel();
            }

            prevBtn.addEventListener('click', () => {
              if (currentIndex > 0) {
                currentIndex--;
                updateCarousel();
              }
            });

            nextBtn.addEventListener('click', () => {
              if (currentIndex < totalSlides - 1) {
                currentIndex++;
                updateCarousel();
              }
            });

            // Update on window resize
            let resizeTimeout;
            window.addEventListener('resize', () => {
              clearTimeout(resizeTimeout);
              resizeTimeout = setTimeout(() => {
                currentIndex = 0;
                updateCarousel();
              }, 250);
            });

            // Initialize
            updateCarousel();
          }
        }
      });
    </script>
  </body>
</html>
