<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>{{ block "title" . }}{{ .Title }} | {{ .Site.Title }}{{ end }}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    {{ $researchCSS := resources.Get "css/research.css" | fingerprint }}
    <link rel="stylesheet" href="{{ $researchCSS.RelPermalink }}" integrity="{{ $researchCSS.Data.Integrity }}">
    {{ block "head" . }}{{ end }}
  </head>
  <body class="bbc-shell">
    <header class="bbc-topbar">
      <button class="bbc-hamburger" id="menu-toggle" aria-label="Toggle menu">
        <span></span>
        <span></span>
        <span></span>
      </button>
      <div class="bbc-brand">
        <a href="/" class="bbc-logo">
          <span class="bbc-logo__block">E</span>
          <span class="bbc-logo__word">nergy</span>
          <span class="bbc-logo__block">M</span>
          <span class="bbc-logo__word">aterials</span>
          <span class="bbc-logo__block">I</span>
          <span class="bbc-logo__word">nterfaces</span>
        </a>
      </div>
      <div class="bbc-header-logos">
        <a href="https://www.materials.ox.ac.uk/" class="bbc-materials-logo" target="_blank" rel="noopener" aria-label="Department of Materials, University of Oxford">
          <picture>
            <source media="(max-width: 900px)" srcset="/images/materials-logo-small.png">
            <img src="/images/materials-logo.png" alt="Department of Materials">
          </picture>
        </a>
        <a href="https://www.ox.ac.uk" class="bbc-oxford-logo" target="_blank" rel="noopener" aria-label="University of Oxford">
          <picture>
            <source media="(max-width: 900px)" srcset="/images/oxford-logo-small.png">
            <img src="/images/oxford-logo.png" alt="University of Oxford">
          </picture>
        </a>
      </div>
    </header>
    {{ with site.Menus.main }}
    <nav class="bbc-nav" id="main-nav">
      {{ range . }}
      <a href="{{ .URL }}">{{ .Name }}</a>
      {{ end }}
    </nav>
    {{ end }}
    <main class="bbc-main">
      {{ block "main" . }}{{ end }}
    </main>
    <footer class="bbc-footer">
      {{ partial "sponsors.html" . }}
      <p>&copy; {{ now.Format "2006" }} {{ .Site.Title }}. All rights reserved.</p>
    </footer>
    <script>
      // Parallax scroll effect for hero banner
      document.addEventListener('DOMContentLoaded', function() {
        const banner = document.getElementById('hero-banner');
        if (banner) {
          const bg = banner.querySelector('.bbc-hero-banner-parallax__bg');

          function updateParallax() {
            const scrolled = window.pageYOffset;
            const bannerHeight = banner.offsetHeight;

            if (scrolled < bannerHeight) {
              const yPos = scrolled * 0.5;
              bg.style.transform = `translate3d(0, ${yPos}px, 0)`;
            }
          }

          window.addEventListener('scroll', updateParallax, { passive: true });
        }

        // Hamburger menu toggle
        const menuToggle = document.getElementById('menu-toggle');
        const mainNav = document.getElementById('main-nav');

        if (menuToggle && mainNav) {
          menuToggle.addEventListener('click', function() {
            menuToggle.classList.toggle('active');
            mainNav.classList.toggle('active');
          });

          // Close menu when clicking a link
          const navLinks = mainNav.querySelectorAll('a');
          navLinks.forEach(link => {
            link.addEventListener('click', function() {
              menuToggle.classList.remove('active');
              mainNav.classList.remove('active');
            });
          });
        }

        function initCarousel(config) {
          const root = document.querySelector(config.rootSelector);
          if (!root) return;

          const track = root.querySelector(config.trackSelector);
          const items = root.querySelectorAll(config.itemSelector);
          const prevBtn = root.querySelector(config.prevSelector);
          const nextBtn = root.querySelector(config.nextSelector);
          const dotsContainer = root.querySelector(config.dotsSelector);
          const metaDisplay = config.metaSelector ? root.querySelector(config.metaSelector) : null;

          if (!track || items.length === 0 || !prevBtn || !nextBtn || !dotsContainer) {
            return;
          }

          let currentIndex = 0;
          let itemsPerSlide = 1;
          let totalSlides = items.length;
          let metaValues = [];

          if (config.getMetaValue) {
            metaValues = Array.from(items).map(config.getMetaValue);
          }

          function recalc() {
            itemsPerSlide = config.getItemsPerSlide ? config.getItemsPerSlide() : 1;
            totalSlides = config.singleItem ? items.length : Math.max(1, Math.ceil(items.length / itemsPerSlide));
            dotsContainer.innerHTML = "";
            for (let i = 0; i < totalSlides; i++) {
              const dot = document.createElement("button");
              dot.classList.add(config.dotClass);
              dot.setAttribute("aria-label", config.ariaDotLabel(i));
              if (i === 0) dot.classList.add(config.dotActiveClass);
              dot.addEventListener("click", () => {
                goToSlide(i);
              });
              dotsContainer.appendChild(dot);
            }
            updateCarousel();
          }

          function updateCarousel() {
            const dots = dotsContainer.querySelectorAll(`.${config.dotClass}`);
            const itemWidth = items[0].offsetWidth;
            const gap = config.gap || 0;
            const offset = currentIndex * (config.singleItem ? itemWidth + gap : itemsPerSlide * (itemWidth + gap));
            track.style.transform = `translateX(-${offset}px)`;

            dots.forEach((dot, index) => {
              dot.classList.toggle(config.dotActiveClass, index === currentIndex);
            });

            prevBtn.disabled = currentIndex === 0;
            nextBtn.disabled = currentIndex >= totalSlides - 1;

            if (metaDisplay && metaValues.length > currentIndex) {
              metaDisplay.textContent = metaValues[currentIndex];
            }
          }

          function goToSlide(index) {
            currentIndex = Math.max(0, Math.min(index, totalSlides - 1));
            updateCarousel();
          }

          prevBtn.addEventListener("click", () => {
            if (currentIndex > 0) {
              currentIndex--;
              updateCarousel();
            }
          });

          nextBtn.addEventListener("click", () => {
            if (currentIndex < totalSlides - 1) {
              currentIndex++;
              updateCarousel();
            }
          });

          let resizeTimeout;
          window.addEventListener("resize", () => {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(() => {
              if (!config.singleItem) currentIndex = 0;
              recalc();
            }, 250);
          });

          recalc();
        }

        initCarousel({
          rootSelector: ".bbc-group-photos-carousel",
          trackSelector: ".bbc-group-photos-carousel__track",
          itemSelector: ".bbc-group-photos-carousel__item",
          prevSelector: ".bbc-group-photos-carousel__button--prev",
          nextSelector: ".bbc-group-photos-carousel__button--next",
          dotsSelector: ".bbc-group-photos-carousel__dots",
          dotClass: "bbc-group-photos-carousel__dot",
          dotActiveClass: "bbc-group-photos-carousel__dot--active",
          ariaDotLabel: index => `Go to photo ${index + 1}`,
          metaSelector: ".bbc-group-photos-carousel__date",
          getMetaValue: item => {
            const img = item.querySelector("img");
            const altText = img ? img.getAttribute("alt") : "";
            return altText.replace("Group photo from ", "");
          },
          gap: 32,
          singleItem: true
        });

        initCarousel({
          rootSelector: ".bbc-news-carousel",
          trackSelector: ".bbc-news-carousel__track",
          itemSelector: ".bbc-news-carousel__item",
          prevSelector: ".bbc-news-carousel__button--prev",
          nextSelector: ".bbc-news-carousel__button--next",
          dotsSelector: ".bbc-news-carousel__dots",
          dotClass: "bbc-news-carousel__dot",
          dotActiveClass: "bbc-news-carousel__dot--active",
          ariaDotLabel: index => `Go to slide ${index + 1}`,
          gap: 24,
          singleItem: false,
          getItemsPerSlide: () => (window.innerWidth <= 900 ? 1 : 3)
        });
      });
    </script>
  </body>
</html>
