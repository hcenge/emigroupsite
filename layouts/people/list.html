{{ define "title" }}{{ .Title }}{{ end }}
{{ define "main" }}
<section class="bbc-people">
  <header class="bbc-people__header">
    <h1 class="bbc-heading">{{ .Title }}</h1>
    {{ with .Content }}<div class="bbc-people__intro">{{ . }}</div>{{ end }}
  </header>

  {{ $groups := slice
    (dict "key" "pi" "title" "Principal Investigators")
    (dict "key" "postdoc" "title" "Postdoctoral Researchers")
    (dict "key" "phd" "title" "DPhil Students")
    (dict "key" "masters" "title" "Master's Students")
    (dict "title" "Alumni" "folder" "people/alumni")
  }}

  {{ range $groups }}
    {{ $scratch := newScratch }}
    {{ if isset . "folder" }}
      {{ with site.GetPage "section" .folder }}
        {{ $scratch.Set "people" .RegularPages }}
      {{ else }}
        {{ $scratch.Set "people" (slice) }}
      {{ end }}
    {{ else }}
      {{ $scratch.Set "people" (where $.Pages "Params.role" .key) }}
    {{ end }}
    {{ $people := $scratch.Get "people" }}
    {{ if gt (len $people) 0 }}
      {{ if and (eq .key "pi") (eq (len $people) 1) }}
        {{ $pi := index $people 0 }}
        <a class="bbc-card bbc-card--pi" href="{{ $pi.RelPermalink }}">
          {{ with $pi.Params.photo }}
          <figure class="bbc-card__media bbc-card--pi__media">
            <img src="{{ . }}" alt="{{ $pi.Title }} portrait">
          </figure>
          {{ end }}
          <div class="bbc-card__body bbc-stack bbc-stack--gap-md bbc-card--pi__body">
            <h2 class="bbc-card__title bbc-card--pi__title">{{ $pi.Title }}</h2>
            {{ with $pi.Params.tagline }}<p class="bbc-people__pi-role">{{ . }}</p>{{ end }}
            {{ with $pi.Params.email }}<p class="bbc-people__pi-contact">{{ . }}</p>{{ end }}
            <div class="bbc-people__pi-bio bbc-stack bbc-stack--gap-sm">{{ $pi.Content }}</div>
            <span class="bbc-people__pi-link">View full profile →</span>
          </div>
        </a>
      {{ else if not (isset . "folder") }}
      <section class="bbc-people__group">
        <div class="bbc-people__group-head">
          <h2>{{ .title }}</h2>
          <span class="bbc-people__count">{{ len $people }}</span>
        </div>
        <div class="bbc-people__grid">
          {{ range sort $people "Params.join_year" "asc" }}
            {{ partial "person-card.html" . }}
          {{ end }}
        </div>
      </section>
      {{ end }}
    {{ end }}
  {{ end }}

  {{ with .Params.group_photos }}
  {{ if gt (len .) 0 }}
  <div class="bbc-group-photos-carousel">
    <div class="bbc-group-photos-carousel__container">
      <div class="bbc-group-photos-carousel__track">
        {{ range . }}
        <div class="bbc-group-photos-carousel__item">
          <img src="{{ .image }}" alt="Group photo from {{ .date }}" class="bbc-group-photos-carousel__image">
        </div>
        {{ end }}
      </div>
      <div class="bbc-group-photos-carousel__controls">
        <button class="bbc-carousel-button bbc-group-photos-carousel__button bbc-group-photos-carousel__button--prev" aria-label="Previous">‹</button>
        <button class="bbc-carousel-button bbc-group-photos-carousel__button bbc-group-photos-carousel__button--next" aria-label="Next">›</button>
      </div>
      <div class="bbc-group-photos-carousel__meta">
        <p class="bbc-group-photos-carousel__date"></p>
        <div class="bbc-group-photos-carousel__dots"></div>
      </div>
    </div>
  </div>
  {{ end }}
  {{ end }}

  {{ range $groups }}
    {{ if isset . "folder" }}
      {{ $scratch := newScratch }}
      {{ with site.GetPage "section" .folder }}
        {{ $scratch.Set "people" .RegularPages }}
      {{ else }}
        {{ $scratch.Set "people" (slice) }}
      {{ end }}
      {{ $people := $scratch.Get "people" }}
      {{ if gt (len $people) 0 }}
      <section class="bbc-people__group bbc-people__group--collapsible">
        <button class="bbc-people__group-head bbc-people__group-head--toggle" onclick="toggleAlumni(this)">
          <div class="bbc-people__group-head-content">
            <h2>{{ .title }}</h2>
            <span class="bbc-people__count">{{ len $people }}</span>
          </div>
          <span class="bbc-people__toggle-icon">▼</span>
        </button>
        <div class="bbc-people__grid bbc-people__grid--alumni bbc-people__grid--collapsed">
          {{ range sort $people "Params.end_year" "desc" }}
            {{ partial "person-card.html" . }}
          {{ end }}
        </div>
      </section>
      {{ end }}
    {{ end }}
  {{ end }}
</section>

<script>
function toggleAlumni(button) {
  const grid = button.nextElementSibling;
  const icon = button.querySelector('.bbc-people__toggle-icon');

  if (grid.classList.contains('bbc-people__grid--collapsed')) {
    grid.classList.remove('bbc-people__grid--collapsed');
    icon.style.transform = 'rotate(180deg)';
  } else {
    grid.classList.add('bbc-people__grid--collapsed');
    icon.style.transform = 'rotate(0deg)';
  }
}
</script>
{{ end }}
